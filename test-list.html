<!DOCTYPE html>
<link rel="import" href="bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="test-panel.html">
<dom-module id="test-list">
    <style>
        test-panel {
            background-color: #eee;
            box-shadow:0 1px 5px rgba(0,0,0,0.3);
            padding:16px 8px 0px 8px;
            position:fixed;
            top:0; right:0;
        }
        ol {
            display:table;
            border-collapse: collapse;
            margin:0 auto;
        }
        li {
            display:table-row;
        }
        li:nth-child(2n) {
            background-color: #eee;
        }
        cell {
            display:table-cell;
            border: solid gray thin;
        }
        .fail {
            background-color: #f66;
        }
        .pass, .blink {
            background-color: #8f8;
        }
        .member {
            background-color: #80d0ff;
        }
        .na, .anonymous {
            background-color: yellow;
        }
    </style>
    <template>
        <iron-ajax
            auto
            url="css-writing-modes-3/implementation-report.json"
            handle-as="json"
            last-response="{{tests}}"
            ></iron-ajax>
        <test-panel id="panel" filter-text="{{filterText}}"></test-panel>
        <ol>
            <li>
                <cell>Test</cell><cell>Result</cell><cell>Source</cell>
            </li>
            <template id="list" is="dom-repeat" items="{{tests}}" filter="{{_filter(filterText)}}" on-dom-change="listUpdated">
                <li>
                    <cell><a href$="{{getUrl(item)}}">{{item.id}}</a></cell>
                    <cell class$="{{getResultClass(item)}}">{{item.result}}</cell>
                    <cell class$="{{getSourceClass(item)}}">{{item.source}}</cell>
                </li>
            </template>
        </ol>
    </template>
    <script>
        function TestStats(total) {
            this.totalCount = total;
            this.count = 0;
            this.passCount = 0;
            this.failCount = 0;
        }
        TestStats.prototype.add = function (test) {
            ++this.count;
            switch (test.result) {
                case 'pass': ++this.passCount; break;
                case 'fail': ++this.failCount; break;
            }
        };
        function formatCount(count, total) {
            return count + " (" + Math.round(count * 100 / total) + "%)";
        }
        TestStats.prototype.done = function () {
            if (this.totalCount && this.totalCount != this.count)
                this.total = formatCount(this.count, this.totalCount);
            else
                this.total = this.count;
            this.coverage = formatCount(this.passCount + this.failCount, this.count);
            this.pass = formatCount(this.passCount, this.count);
            this.fail = formatCount(this.failCount, this.count);
        };
        TestStats.create = function (tests, filter) {
            var stats = new TestStats(tests.length);
            if (filter) {
                tests.forEach(function (test) {
                    if (filter(test))
                        stats.add(test);
                });
            } else {
                tests.forEach(function (test) {
                    stats.add(test);
                });
            }
            stats.done();
            return stats;
        };

        function createFilter(text) {
            function matchTest(test, text) {
                if (!text)
                    return true;
                if (text[0] == '!') {
                    if (text.length == 1)
                        return true;
                    return !matchTest(test, text.slice(1));
                }
                return test.id.indexOf(text) >= 0 ||
                    test.result.indexOf(text) >= 0 ||
                    (test.source && test.source.indexOf(text) >= 0);
            }
            if (!text) return null;
            text = text.trim();
            if (!text) return null;
            var filters = text.split(' ');
            if (filters.length == 1)
                return function (test) { return matchTest(test, filters[0]); };
            return function (test) {
                for (var i = 0; i < filters.length; ++i) {
                    var filter = filters[i];
                    if (!filter) continue;
                    if (!matchTest(test, filter))
                        return false;
                }
                return true;
            };
        }

        Polymer({
            is: 'test-list',
            ready: function () {
                if (location.search && location.search.lastIndexOf('?q=', 0) == 0)
                    this.filterText = location.search.slice(3);
            },
            _filter: function (filter) {
                return createFilter(filter);
            },
            listUpdated: function () {
                this.$.panel.updateStats(TestStats.create(this.tests, this.$.list.filter));
                if (this.filterText)
                    window.history.replaceState(null, '', '?q=' + this.filterText);
                else
                    window.history.replaceState(null, '', window.location.pathname);
            },
            getUrl: function (test) {
                return 'http://test.csswg.org/harness/test/css-writing-modes-3_dev/single/' + test.id + '/format/html5/';
            },
            getResultClass: function (test) { return test.result == '?' ? 'na' : test.result; },
            getSourceClass: function (test) { return !test.source ? '' :
                test.source == 'anonymous' || test.source == 'blink' ? test.source :
                'member'; }
        });
    </script>
</dom-module>
